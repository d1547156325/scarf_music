require(["core/config","core/utils","tmpl/uuser/message_list","tmpl/uuser/message_list_edit","widget/filed/filed","widget/toast/toast","page/dynamic/dynamic_tpl"],function(i,e,s,t,a,o,n){var d=null,c=null;var l=$(".message-tmpl"),r=$(".message-list-loading");var m=function(i){i=i||0;if(i==0){msg_id=null,c=null;l.empty()}e.tingApi("baidu.ting.ugcmsg.recvMessage",{msg_type:msg_conf[key],size:10,msg_id:msg_id,timestamp:c}).done(function(i){var e=i.result.content;if(!c||e.length>0){l.append(s({list:e,key:key||""}))}if(key=="at"){for(var t=0;t<e.length;t++){var a=e[t];if(a.source_type==5||a.source_type==6){source=a.source_info;source.msgid=a.source_id;n.eventDynamic({dyData:source.msg_parent?source.msg_parent:source})}}}var o=i.result.last_msg;if(o){msg_id=o.msg_id,c=o.ctime}if(!i.result.havemore){r.remove()}else{$(window).bind("scroll",u)}}).fail(function(i){})},u=function(){var i=parseFloat($(window).height())+parseFloat($(window).scrollTop());if($(document).height()-i<100){$(window).unbind("scroll");m(c)}};m(c);var p=$(".message-list-hook"),g=[];var f=function(i){i.find(".message-edit-tmpl").empty();i.removeClass("has-edit");g=[]},h=function(i,e){var s=120;var t=p.find(".edit-num-hook"),a=s-e.length,o="",n="";if(a<0){o="超过"+Math.abs(a)+"个字";n="tip-error"}else{o="还能输入"+a+"个字"}t.html(o).removeClass("tip-error").addClass(n);var d=p.find(".send-hook");if(d.hasClass("disabled")&&$.trim(e)!=""&&n==""){d.removeClass("disabled")}else if(!d.hasClass("disabled")&&$.trim(e)==""||n!=""){d.addClass("disabled")}},y=function(i,e){g.push({userid:i,username:e})};p.on("click",".reply-hook",function(s){var n=$(this).parents("li").eq(0);if(n.hasClass("has-edit")){f(n)}else{f($(".message-list-hook li.has-edit"));n.find(".message-edit-tmpl").html(t(d));n.addClass("has-edit");var d=$(this).data("item"),c=d.comment_info,l=d.source_info;var r=a.init({baseEl:p});r.$editText.on("add:user",function(i,e){y(e.userid,e.username)});r.$editText.on("edit",function(i,e,s){h(e,s)});r.$editText.on("send",function(s,t){var n=$(this),m=n.val();var u={comm_content:m,msg_users:JSON.stringify(g),author_id:c.author.userid||0};if(c.comment){u.comm_id=c.com_id;u.type=c.pid;u.type_id=c.thread_id}else{switch(d.source_type){case 0:break;case 1:u.type=1;u.type_id=l.content_id;break;case 2:break;case 3:break;case 4:u.type=c.pid;u.type_id=c.thread_id;break;case 5:u.type=4;u.type_id=d.source_id;break;case 6:u.type=5;u.type_id=d.source_id;break}}e.tingApi("baidu.ting.ugcmsg.addComment",u,{type:"POST"}).done(function(i){a.clear(r);o.show({data:{cls:"succ",text:"发送成功"}})}).fail(function(e){var s="发送失败";if(e){var t=i.cfg.tingApi.code;switch(e.error_code){case t.USER_UNLOGIN:s="未检测登录状态";break;case t.CONTENT_HAVE_ANTI:s="内容含有黄反或敏感信息，请审查";break}}o.show({data:{cls:"fail",text:s}})})});r.$editText.focus()}});p.on("click","http://static1.qianqian.com/web/static/j/li.link",function(i){i.stopPropagation();var e=$(this).data("link");if(e!=""){window.open(e)}}).on("click","li.link a, li .message-edit, .dynamic-pics-hook",function(i){i.stopPropagation()}).on("click",".dynamic .dynamic-pics-hook, .dynamic .icon-play",function(i){i.stopPropagation()}).on("click",".song-play-hook",function(){var i=$(this).data("songid"),e={moduleName:"playSong"};ting.media.playSong(i,e);self.tip().tip("tipup",{msg:"已开始播放",iconClass:"tip-success"})}).on("click",".songlist-play-hook",function(){var i=$(this).data("listid"),e={moduleName:"songMenu"};ting.media.playSongMenu(i,e);$(this).tip().tip("tipup",{msg:"已开始播放！",iconClass:"tip-success"})}).on("click",".album-play-hook",function(){var i=$(this).data("albumid"),e={moduleName:"playAlbum"};ting.media.playAlbum(i,e);$(this).tip().tip("tipup",{msg:"已开始播放！",iconClass:"tip-success"})})});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/