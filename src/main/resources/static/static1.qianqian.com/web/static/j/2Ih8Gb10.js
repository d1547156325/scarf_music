define(["core/config","core/utils","widget/toast/toast","http://static1.qianqian.com/web/static/j/plugin/jquery.form","http://static1.qianqian.com/web/static/j/plugin/jquery.md5"],function(e,t,a){var n=6,r="jpg|jpeg|png|gif",i=10*1048576,l="multi-form",u=".img-upload-hook",o=null,f=null,e=e.cfg.multiApi;var c=function(e){o=e.baseEl;f=$(".dynamic-edit-image",o).eq(0);m();g()},m=function(){$(u,o).each(function(e,t){var a=$(t),n=a.attr("name")||"filePath";a.attr("multiple","multiple").prop("multiple",true);a.attr("name",n+"[]");a.wrap('<form class="'+l+'" method="POST" enctype="multipart/form-data"></form>')})},s=function(e){var t=f.find("ul li").length+e.length;if(t>n){a.show({innerSelect:".toast-tmpl",data:{cls:"fail",text:"最多添加"+n+"张图片哦"}});return false}return true},p=function(e){var t=true,n=r.replace(/\W+/g,"|").replace(/^\W|\W$/g,""),i=new RegExp("\\.("+(n?n:"")+")$","gi");$.each(e,function(e,n){var r=n.name||n;if(!r.match(i)){t=false;a.show({innerSelect:".toast-tmpl",data:{cls:"fail",text:"请选择图片文件"}});return}});return t},d=function(e){var t=true;$.each(e,function(e,n){var r=n.size;if(r>i){t=false;a.show({innerSelect:".toast-tmpl",data:{cls:"fail",text:"图片大小超过10M"}});return}});return t},g=function(){f.on("click","li .remove",function(){$(this).parent("li").remove();if(f.find("ul li").length==0){f.hide()}});$(u,o).change(function(t){var a=this,n=a.files||new Array(a.value);if(s(n)&&p(n)&&d(n)){var r=f.find("ul");$.each(n,function(e,t){var a=$('<li class="multi_item_'+$.md5(t.name)+' img-load"><a href="javascript:;" class="remove"></a></li>');r.append(a)});$(a).parent("form").ajaxSubmit({url:e.url,type:"POST",dataType:"json",success:function(t){for(var a=0;a<t.result.length;a++){var n=t.result[a];if(n.error_no==e.code.SUCCESS){$(".multi_item_"+$.md5(n.file_name)).each(function(e,t){if(!$(t).data("file")){$(t).prepend('<img src="'+n.url+'" />').attr("data-file",n.url);$(t).find("img").load(function(){$(t).removeClass("img-load")})}})}else{$(".multi_item_"+$.md5(n.file_name)).addClass("img-error")}}},error:function(e,t,a){console.log(e.responseText)}});$(a).val("").attr("value","")[0].value="";f.show()}return})};return{init:function(e){c(e);return f}}});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/