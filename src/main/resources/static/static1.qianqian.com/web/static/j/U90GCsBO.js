define(["core/utils","tmpl/songlist/searchSongTmpl","tmpl/songlist/listenSongTmpl","widget/pop_window/pop_window","widget/toast/toast","plugin/jquery.dragsort-0.5.1","plugin/jquery.imgareaselect","http://static1.qianqian.com/web/static/j/plugin/jquery.form"],function(utils,searchSongTpl,listenSongTpl,popWindow,toastPlugin){var pageCurrentNum=1,allowScroll=true,pageTurn=false,$cutControlTip=$(".cut-control-tip"),$editList=$(".edit-list"),$songlistNum=$(".songlist-num"),$editDesc=$(".edit-desc"),$editName=$(".edit-name"),editNameMax=30,editDescMax=500,$editListTotal=$(".edit-list-total"),$songlistTitleTip=$(".songlist-title-tip"),$descText=$(".desc-text"),$loading=$(".pop-add-song .loading"),$addSongBtn=$(".add-song-btn"),$pageIconPrevSonglist=$(".page-icon-prev-songlist"),$pageIconPrevListen=$(".page-icon-prev-listen"),$pageIconPrevSearch=$(".page-icon-prev-search"),$pageIconNextSonglist=$(".page-icon-next-songlist"),$pageIconNextSearch=$(".page-icon-next-search"),$pageIconNextListen=$(".page-icon-next-listen"),$pageSonglistCurrent=$(".page-current-num-songlist"),$pageSearchCurrent=$(".page-current-num-search"),$pageListenCurrent=$(".page-current-num-listen"),$pageTotalSonglist=$(".page-total-num-songlist"),$pageTotalListen=$(".page-total-num-listen"),$pageTotalSearch=$(".page-total-num-search"),$listenResultTip=$(".listen-result-tip"),$searchResultTip=$(".search-result-tip"),$addSongsBg=$(".add-songs-bg"),$editTagsBox=$(".edit-tags-box"),$editTagMore=$(".edit-tag-more"),$editSelectTagTips=$(".edit-select-tags-tips"),$removeThisTagBtn=$(".remove-this-tag-btn"),$popSearchTab=$(".pop-add-search-tab"),$popListenTab=$(".pop-add-listen-tab"),$popSearch=$(".pop-search"),$popListen=$(".pop-listen"),$searchText=$(".search-text"),$songAddBtn=$(".song-add-btn"),$submitBtn=$(".songlist-edit-submit"),$editCover=$(".edit-cover-preview"),selectedTagsArr=[],allTagsArr=[],listLegth=$editList.find("li").length,pageTotal=Math.ceil(listLegth/10),editListScrollTop=0,editListIds=[],ulOffSetTop=0,ulScrollTimer="",draging=false,diylistEdit={add:false,del:false,rank:false},diyInfoEdit={name:false,checkName:true,checkDesc:true,pic:false,tag:false},listenOpt={pageIndex:0,pageTotal:0,pageSize:10},searchOpt={pageIndex:1,pageTotal:0,pageSize:10},cut={uploadImg:{},preview:280,previewMini:160,mix:500,allowUpload:true},mixControl="",diyInfo=true,diyList=true;init=function(){editCoverPop=popWindow.create({title:"更改封面",offsetY:-70,closeCallback:function(){$("#ferret").imgAreaSelect({remove:true});initImgAreaSelect();return true}});popWindow.setContent(editCoverPop,$(".pop-edit-cover").show());popWindow.hide(editCoverPop);addSongPop=popWindow.create({title:"添加歌曲"});popWindow.setContent(addSongPop,$(".pop-edit-list").show());popWindow.hide(addSongPop);$songlistNum.html(editNameMax-$editName.val().length);$descText.html(editDescMax-$editDesc.val().length);var e=$editList.find("li").length;e>3?$addSongsBg.hide():$addSongsBg.show()};loadToastTmpl=function(e,t,i){toastPlugin.show({innerSelect:".toast-tmpl",data:{cls:e,text:t},callback:i})};$editDesc.keyup(function(){checkSonglistDesc()});$editDesc.focus(function(){$(this).attr("placeholder","")});$editDesc.blur(function(){checkSonglistDesc()});checkSonglistDesc=function(){diyInfoEdit.desc=true;var e=$editDesc;var t=e.val();if(t.length>editDescMax){e.addClass("red-border");$descText.html(editDescMax-t.length).addClass("c-red");diyInfoEdit.checkDesc=false}else{diyInfoEdit.checkDesc=true;e.removeClass("red-border");$descText.html(editDescMax-t.length).removeClass("c-red")}};$editName.keyup(function(){var e=$editName.val();if(e.length>editNameMax){$editName.addClass("red-border");$songlistNum.html(editNameMax-e.length);$editName.addClass("red-border");diyInfoEdit.checkName=false;$songlistTitleTip.html("歌单名需在 "+editNameMax+" 个字以内")}else{$editName.removeClass("red-border");$songlistNum.html(editNameMax-e.length);diyInfoEdit.checkName=true;$editName.removeClass("red-border");$songlistTitleTip.html("")}});$editName.blur(function(){checkSonglistTitle()});checkSonglistTitle=function(){diyInfoEdit.name=true;var e=$editName.val();if(!e||$.trim(e)==""){$editName.addClass("red-border");diyInfoEdit.checkName=false;$songlistTitleTip.html("歌单名不能为空");return false}if(e.length>editNameMax){$editName.addClass("red-border");$songlistNum.html(editNameMax-e.length);$editName.addClass("red-border");diyInfoEdit.checkName=false;$songlistTitleTip.html("歌单名需在 "+editNameMax+" 个字以内")}else{$editName.removeClass("red-border");$songlistNum.html(editNameMax-e.length);diyInfoEdit.checkName=true;$editName.removeClass("red-border");$songlistTitleTip.html("")}};$editName.focus(function(){$songlistTitleTip.html("");$editName.removeClass("red-border")});$editTagMore.toggle(function(){editTagsBoxScrollHeight=$editTagsBox[0].scrollHeight-77;$editTagsBox.animate({height:editTagsBoxScrollHeight},500,function(){$editTagMore.html("- 收起");$(".edit-tags-hot").fadeOut(500)});tagInit()},function(){$editTagsBox.animate({height:35},500,function(){$editTagMore.html("+ 展开");$(".edit-tags-hot").fadeIn(500)});tagInit()});tagInit=function(){$editSelectTagTips.find("a").each(function(e){var t=$(this).text();$editTagsBox.find("a").each(function(e){if($(this).text()===t){$(this).addClass("selected")}})})};tagInit();$editTagsBox.find("a").live("click",function(){var e=$(this);diyInfoEdit.tag=true;if(e.hasClass("selected")){var t=e.text();e.removeClass("selected");$editSelectTagTips.find("a").each(function(e){if($(this).text()===t){$(this).remove()}});return false}if($editSelectTagTips.find("a").length>=3){loadToastTmpl("fail","最多选择三个标签！");return false}if($editSelectTagTips.find("a").length===0){$editSelectTagTips.html("")}$(this).addClass("selected");var i=$(this).clone();$editSelectTagTips.append(i.addClass("selected").append('<i class="remove-this-tag-btn t"></i>'))});$removeThisTagBtn.live("click",function(){diyInfoEdit.tag=true;var e=$(this).closest("a");$editTagsBox.find("a").each(function(t){if(e.text()===$(this).text()){$(this).removeClass("selected")}});e.remove();if($editSelectTagTips.find("a").length===0){$editSelectTagTips.html("选择三个标签，让歌单更容易被发现")}});$(".songlist-edit-cover-btn").click(function(){diyInfoEdit.pic=true;popWindow.show(editCoverPop)});$cutControlTip.html("不能小于"+cut.mix+"*"+cut.mix);function preview(e,t){var i=cut.previewMini/(t.width||1);var a=cut.previewMini/(t.height||1);$(".upload-img").css({width:Math.round(i*cut.uploadImg._width)+"px",height:Math.round(a*cut.uploadImg._height)+"px",marginLeft:"-"+Math.round(i*t.x1)+"px",marginTop:"-"+Math.round(a*t.y1)+"px"})}function getFileUrl(e){var t=null;if(window.createObjectURL!=undefined){t=window.createObjectURL(e)}else if(window.URL!=undefined){t=window.URL.createObjectURL(e)}else if(window.webkitURL!=undefined){t=window.webkitURL.createObjectURL(e)}return t}initImgAreaSelect=function(){$(".upload-btn").html("选择图片").removeClass("upload-btn-gray");$("#ferret").imgAreaSelect({aspectRatio:"1:1",handles:true,onSelectChange:preview,onSelectEnd:function(e,t){mixControl=Math.abs(t.x1-t.x2)*(cut.uploadImg.width/cut.uploadImg._width);if(mixControl<cut.mix){$cutControlTip.addClass("c-red")}else{$cutControlTip.removeClass("c-red")}var i={x1:cut.uploadImg.width*t.x1/cut.uploadImg._width,y1:cut.uploadImg.height*t.y1/cut.uploadImg._height,x2:cut.uploadImg.width*t.x2/cut.uploadImg._width,y2:cut.uploadImg.height*t.y2/cut.uploadImg._height};$('input[name="x1"]').val(i.x1);$('input[name="y1"]').val(i.y1);$('input[name="x2"]').val(i.x2);$('input[name="y2"]').val(i.y2)}})};$(".select-pic").change(function(){var e=this,t="";var i=$('<img src=""/>');i.css({position:"absolute",left:"0",top:"0",visibility:"hidden","z-index":"1"});$("body").append(i);var a=function(e){cut.uploadImg.height=i.height();cut.uploadImg.width=i.width();i.remove();var t=Math.max(cut.uploadImg.height,cut.uploadImg.width);if(cut.uploadImg.width===t){cut.uploadImg._height=cut.uploadImg.height*cut.preview/cut.uploadImg.width;cut.uploadImg._width=cut.preview;cut.uploadImg._top=(cut.preview-cut.uploadImg._height)/2;cut.uploadImg._left=0}else{cut.uploadImg._width=cut.uploadImg.width*cut.preview/cut.uploadImg.height;cut.uploadImg._height=cut.preview;cut.uploadImg._left=(cut.preview-cut.uploadImg._width)/2;cut.uploadImg._top=0}$("#ferret").css({width:cut.uploadImg._width+"px",height:cut.uploadImg._height+"px",top:cut.uploadImg._top+"px",left:cut.uploadImg._left+"px"});e(cut)};i.load(function(){$(".upload-tip").show();a(function(){$("#ferret").attr("src",t);$(".upload-img").attr("src",t)})});if($.browser.msie){try{t=getFileUrl(e.files[0]);i.attr("src",t)}catch(l){e.select();if(top!=e){window.parent.document.body.focus()}else{e.blur()}t=document.selection.createRange().text;document.selection.empty();i.css({filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=image, src="+t+")"});a(function(){$("#ferret").css({filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale, src="+t+")"}).attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==");$(".upload-img").css({width:"100%",height:"100%",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale, src="+t+")"}).attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==")})}}else{t=getFileUrl(e.files[0]);i.attr("src",t)}$(".upload-btn").html("重传图片");$(".pop-cut-img").show();$(".upload-img-box").insertAfter($(".upload-preview-text"));initImgAreaSelect()});$("#upload").submit(function(e){var self=$(this);if($('input[name="x1"]').val()===""){loadToastTmpl("fail","请选择图片剪裁区域！");return false}if(mixControl<cut.mix){loadToastTmpl("fail","裁剪图片不能小于"+cut.mix+"*"+cut.mix);return false}$(".upload-btn").html("正在上传...").addClass("upload-btn-gray");$(".select-pic").addClass("select-pic-gray");$("#ferret").imgAreaSelect({remove:true});self.ajaxSubmit(function(res){var result=eval("("+res+")");var opt="";if(result.error_no===22e3){$(".imgareaselect-outer").hide();$editCover.attr("src",result.url);$(".upload-btn").html("选择图片").removeClass("upload-btn-gray");$(".select-pic").removeClass("select-pic-gray")}else{loadToastTmpl("fail","选择图片失败，请重试！")}initImgAreaSelect();popWindow.hide(editCoverPop)});e.preventDefault();return false});$editList.dragsort({dragSelector:"em",dragBetween:true,dragEnd:saveOrder,placeHolderTemplate:""});function saveOrder(){draging=false;songlistChange();diylistEdit.rank=true;editListIds=[];$(".list-icon-del").each(function(e){editListIds.push(Number($(this).data("songid")))});var e=$editList.find("li").map(function(){return $(this).children().html()}).get()}function editListDrag(e){draging=true;ulOffSetTop=$editList.offset().top,liOffSetTop=$(e.target).offset().top;if(liOffSetTop-ulOffSetTop>470&&allowScroll&&pageCurrentNum<pageTotal){allowScroll=false;$editList.animate({scrollTop:pageCurrentNum*470},700,function(){ulScrollTimer=setTimeout(function(){pageCurrentNum++;$pageSonglistCurrent.html(pageCurrentNum);allowScroll=true;clearTimeout(ulScrollTimer)},1e3)})}if(liOffSetTop-ulOffSetTop<0&&allowScroll&&pageCurrentNum>1){allowScroll=false;$editList.animate({scrollTop:0},700,function(){ulScrollTimer=setTimeout(function(){pageCurrentNum--;allowScroll=true;$pageSonglistCurrent.html(pageCurrentNum);clearTimeout(ulScrollTimer)},1e3)})}}$editList.bind("scroll",function(){if(draging||pageTurn){return false}editListScrollTop=$(this).scrollTop();pageCurrentNum=Math.ceil(editListScrollTop/470)+1;$pageSonglistCurrent.html(pageCurrentNum)});for(var i=0;i<$(".list-icon-del").length;i++){editListIds.push($($(".list-icon-del")[i]).data("songid"))}$(".list-icon-del").live("click",function(){var e=$(this);selfId=e.data("songid");diylistEdit.del=true;$(".song-"+selfId).remove();editListIds.splice($.inArray(selfId,editListIds),1);$(".song-add-btn-"+selfId).removeClass("song-add-btn-gray").html("添加");songlistChange()});$pageIconPrevSonglist.click(function(){if(pageTurn){return false}if(pageCurrentNum>1){pageTurn=true;$editList.animate({scrollTop:(pageCurrentNum-2)*470},700,function(){pageTurn=false;pageCurrentNum--;$pageSonglistCurrent.html(pageCurrentNum)})}});$pageIconNextSonglist.click(function(){if(pageTurn){return false}if(pageCurrentNum<pageTotal){pageTurn=true;$editList.animate({scrollTop:pageCurrentNum*470},700,function(){pageCurrentNum++;$pageSonglistCurrent.html(pageCurrentNum);pageTurn=false})}});$addSongBtn.click(function(){diylistEdit.add=true;popWindow.show(addSongPop)});$popSearchTab.bind("click",function(){$popSearch.show();$popListen.hide();$(this).addClass("pop-add-tab-active");$popListenTab.removeClass("pop-add-tab-active")});$popListenTab.click(function(){$popSearch.hide();$popListen.show();$(this).addClass("pop-add-tab-active");$popSearchTab.removeClass("pop-add-tab-active");listenSong()});$(".search-btn").click(function(){searchSong(searchOpt.pageIndex)});$searchText.keyup(function(e){if(e.keyCode==13){searchSong(searchOpt.pageIndex)}});$pageIconPrevSearch.click(function(){if(searchOpt.pageIndex<=1){return false}searchOpt.pageIndex--;searchSong()});$pageIconNextSearch.click(function(){if(searchOpt.pageIndex*searchOpt.pageSize>=searchOpt.pageTotal){return false}searchOpt.pageIndex++;searchSong()});function searchSong(e){if($searchText.val()==""){$searchText.addClass("red-border").focus();return false}else{$searchText.removeClass("red-border")}$loading.show();searchOpt.pageIndex=searchOpt.pageIndex||1;var t=$searchText.val();var i={query:t,isNew:1,page_no:searchOpt.pageIndex,page_size:searchOpt.pageSize,type:0};$pageSearchCurrent.html(searchOpt.pageIndex);utils.tingApi("baidu.ting.search.merge",i).done(function(e){if(e.error_code==22e3&&e.result.song_info){searchOpt.pageTotal=e.result.song_info.total;$pageTotalSearch.html(Math.ceil(searchOpt.pageTotal/10));$(".pop-search-result").html(searchSongTpl(e.result.song_info));$loading.hide();$searchResultTip.hide()}else{$searchResultTip.show();$loading.hide()}}).fail(function(e){$searchResultTip.show()})}$pageIconPrevListen.click(function(){if(listenOpt.pageIndex<=1){return false}listenOpt.pageIndex--;listenSong()});$pageIconNextListen.click(function(){if(listenOpt.pageIndex*listenOpt.pageSize>=listenOpt.pageTotal){return false}listenOpt.pageIndex++;listenSong()});function listenSong(e){$loading.show();listenOpt.pageIndex=listenOpt.pageIndex||1;var t={rn:listenOpt.pageSize,pn:listenOpt.pageIndex*10};$pageListenCurrent.html(listenOpt.pageIndex);utils.tingApi("baidu.ting.favorite.getListenHistory",t).done(function(e){if(e.error_code==22e3&&e.result.songlist){listenOpt.pageTotal=e.result.total;$pageTotalListen.html(Math.ceil(listenOpt.pageTotal/10));$(".pop-listen-result").html(listenSongTpl(e.result));$listenResultTip.hide()}else{$listenResultTip.show();$(".pop-listen-result").html("")}$loading.hide()}).fail(function(e){$loading.hide();$listenResultTip.show()})}$songAddBtn.live("click",function(){var e=$(this);selfData=e.data("songinfo");if($.inArray(Number(selfData.id),editListIds)!=-1){loadToastTmpl("fail","歌曲已存列表中！");e.addClass("song-add-btn-gray").html("已添加")}else{if(!selfData){return false}var t='<li class="song-'+selfData.id+'">                 <em class="list-drag-icon"></em>                <em class="list-index">00</em>                <a href="song/'+selfData.id+'" class="list-song" title="'+selfData.id+'">'+selfData.title+'</a>                <a href="artist/'+selfData.artist_id+'" class="list-artist" title="'+selfData.author+'">'+selfData.author+'</a>                <a href="album/'+selfData.album_id+'" class="list-album" title="'+selfData.album_title+'">'+selfData.album_title+'</a>                <span class="list-icon-del" title="" data-songid="'+selfData.id+'"></span>                </li>';$editList.prepend(t);e.addClass("song-add-btn-gray").html("已添加");editListIds.unshift(Number(selfData.id))}songlistChange()});songlistChange=function(){var e=$(".list-index");var t=$editList.find("li").length;pageTotal=Math.ceil(t/10);t>3?$addSongsBg.hide():$addSongsBg.show();e.each(function(t){if(t<9){k="0"+(t+1)}else{k=t+1}e.eq(t).html(k)});$editListTotal.html("歌曲("+t+")");$pageTotalSonglist.html(Math.ceil(t/10))};$submitBtn.click(function(){var e=$(this);var t=e.data("listid");var i=false;var a=[];if(!t){loadToastTmpl("fail","歌单不存在或已删除!");return false}if(!diyInfoEdit.checkName){loadToastTmpl("fail","歌单名不符合要求!");return false}if(!diyInfoEdit.checkDesc){loadToastTmpl("fail","歌单简介不符合要求!");return false}$editSelectTagTips.find("a").each(function(e){a.push($(this).text())});var l="",s={list_id:t,title:$editName.val(),desc:$editDesc.val(),tag:a.toString(),diypic:l};if(!(!diyInfoEdit.name&&!diyInfoEdit.desc&&!diyInfoEdit.pic&&!diyInfoEdit.tag)){i=true;diyInfo=false;if($editCover.attr("src")!==$editCover.attr("data-initpic")){s.diypic=$editCover.attr("src")}utils.tingApi("baidu.ting.ugcdiy.editDiy",s).done(function(e){if(e.error_code==22e3){diyInfo=true;if(diyList&&diyInfo){loadToastTmpl("succ","保存成功!");var t=setTimeout(function(){window.location.href="http://static1.qianqian.com/songlist/"+s.list_id;clearTimeout(t)},1500)}}}).fail(function(e){var t="";if(e.error_code==22231){if(e.error_msg=="title"){t="歌单名称含有敏感内容!";$songlistTitleTip.html("歌单名称含有敏感内容，换一个吧");$editName.addClass("red-border")}if(e.error_msg=="desc"){t="歌单简介含有敏感内容!"}}else{t="歌单信息保存失败!"}loadToastTmpl("fail",t)})}if(!(!diylistEdit.add&&!diylistEdit.del&&!diylistEdit.rank)){i=true;diyList=false;var o={list_id:t,song_ids:editListIds.toString()};utils.tingApi("baidu.ting.ugcdiy.sortDiySongs",o).done(function(e){if(e.error_code==22e3){diyList=true;if(diyList&&diyInfo){loadToastTmpl("succ","保存成功");window.location.href="http://static1.qianqian.com/songlist/"+s.list_id}}}).fail(function(e){loadToastTmpl("fail","歌单列表保存失败")})}if(!i){loadToastTmpl("fail","歌单信息没有任何变动")}});init();return{_drag:function(e){editListDrag(e)}}});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/