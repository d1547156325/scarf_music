define(["core/utils","widget/at/at","widget/face/face","plugin/jquery.filed"],function(e,t,i){var n={baseEl:$("body"),atPlugin:true,facePlugin:true};var s=function(e,t){e.options=$.extend(n,t);e.$base=e.options.baseEl;e.$editText=$(".textarea-hook",e.$base);e.$editTextPos=$(".textarea-pos-hook",e.$base);e.$btnSend=$(".send-hook",e.$base);a(e)},a=function(e){e.timeout=null;if(e.options.atPlugin){e.at=t.init({baseEl:e.$base,editEl:e.$editText,innerSelect:".at-tmpl"});e.at.$atEdit.on("select:user",function(t,i){e.msgUser=false;e.$editText.trigger("add:user",i);o(e)});$(".at-hook",e.$base).on("click",function(){clearTimeout(e.timeout);e.$editText.iAddField("@");o(e)})}else{t={hide:function(){},clear:function(){}}}if(e.options.facePlugin){$(".face-hook",e.$base).on("click",function(){e.face=i.show(e.face,{baseEl:e.$base,editEl:e.$editText,btnEl:$(this),innerSelect:".face-tmpl"});if(e.face){e.face.$faceEdit.off("select:face").on("select:face",function(t,i){e.$editText.trigger("add:face",i);o(e)})}}).on("mousedown",function(){i.clear(e.face);return false})}else{i={clear:function(){}}}var n=true;e.$editText.on("propertychange",function(){}).on("input",function(t){n=false;o(e)}).on("blur",function(){e.timeout=setTimeout(function(){t.hide(e.at)},200)}).on("focus",function(){}).on("keydown",function(t){var i=t.keyCode||t.which;if(i==13||i==38||i==40){return!e.queryUser}}).on("keyup",function(t){t=window.event||t;var i=t.keyCode||t.which;if(i==8||i==13||i==38||i==40){o(e,i);return false}else{if(n){o(e)}}});e.$btnSend.on("click",function(){if($(this).hasClass("disabled")){return}e.$editText.trigger("send",$(this))})};var o=function(i,n){t.clear(i.at);var s=valuepos=i.$editText.val(),a=i.$editText.iGetFieldPos(),o=!!(s.substr(a-1,1)=="@"),r=!!(s.substr(a-1,1)==" "),u="",l=(new Date).getTime(),f=!!(n==8),c=!!(n==13),d=!!(n==38),p=!!(n==40);valuepos=e.htmlDecode(valuepos);if(i.queryUser){var g=s.substr(0,a),v=g.lastIndexOf("@")+1;if(v>0){i.queryUser=2;u=g.slice(v)}}if(o){i.msgUser=true;i.queryUser=1;valuepos=valuepos.substr(0,a-1)+'<span id="at-'+l+'">@</span>'+valuepos.substr(a,valuepos.length)}else if(f){if(i.queryUser===1){i.queryUser=0}if(i.queryUser!==2){t.hide(i.at)}}if(f){}if(i.options.atPlugin&&r){if(i.msgUser){var g=s.substr(0,a),v=g.lastIndexOf("@")+1,b=g.slice(v,-1);if(v>0&&b.split(" ").length==1){i.$editText.trigger("add:user",{userid:0,username:b})}i.msgUser=false}i.queryUser=0;t.hide(i.at)}valuepos=valuepos.replace(/\n/g,"<br/>");i.$editTextPos.html(valuepos);i.$editTextPos.scrollTop(i.$editText.scrollTop());if(i.queryUser&&i.options.atPlugin){if(c||d||p){var x=c?1:d?2:3;t.control(i.at,x)}else{var T=$("#at-"+l);t.load(i.at,T,u)}}i.$editText.trigger("edit",[a,s])};return{init:function(e){var t={};s(t,e);return t},setText:function(e,t){e.$editText.val(t);o(e)},clear:function(e){if(!e){return}e.$editText.val("");o(e)},setFild:function(e,t){t=t||0;e.$editText.iSelectField(t)}}});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/