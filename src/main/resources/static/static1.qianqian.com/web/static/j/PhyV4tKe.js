require(["core/utils","tmpl/uuser/letter_menu","tmpl/uuser/letter_talk","widget/filed/filed","widget/toast/toast"],function(e,t,i,n,s){var a=myself.userid||0,r=other.userid||0;var o=$(".message-edit");var l=n.init({baseEl:o,atPlugin:false});l.$editText.on("edit",function(e,t,i){u(t,i)});l.$editText.on("send",function(e,t){var i=$(this),r=i.val();if($.trim(r)==""){s.show({data:{cls:"fail",text:"无私信内容"}});return}var o={msg_type:2,source_id:"",source_type:7,op_type:0,content:r},u={msg:JSON.stringify(o),dst_uid:p.userid,serverid:10001,type:1};var d=N.sentMessage(u);o.random_id=d;_.push(d);H({src_uid:a,dst_uid:u.dst_uid},o);setTimeout(function(){var e=_.toString().indexOf(d);if(e>-1){var t=$("#talkLi"+d,k);if(t&&t.length>0){t.addClass("error")}_.splice(e,1)}},10*1e3);n.clear(l)});var u=function(e,t){var i=1e3;var n=i-t.length,a=this;if(n<0){l.$editText.attr("readonly","readonly");s.show({innerSelect:".toast-tmpl",data:{cls:"fail",text:"超过"+i+"字了，太多啦"},callback:function(){l.$editText.removeAttr("readonly");l.$editText.val(t.substr(0,i))}})}},d=function(){$(".talk-content").addClass("talk-content0");l.$btnSend.addClass("disabled")},c=function(){$(".talk-content").removeClass("talk-content0");l.$btnSend.removeClass("disabled")};var f=null,m=null,v=null,g=$(".letter-menu-wrap");var p={},h={},_=[],k=$(".talk-content-wrap");var b=function(){e.tingApi("baidu.ting.ugcmsg.getContactList",{size:20,msg_id:f,last_uid:m}).always(function(e){var t=[];if(e&&e.result){t=e.result.content;y(t);var i=e.result.last_msg;if(i){f=i.msg_id;m=i.chat_uid}if(e.result.havemore){g.bind("scroll",w)}}})},y=function(e,i){if(e.length>0){setTimeout(c,100)}g.find("ul").append(t({list:e||{},myself:myself,otherid:i||r,cls:p.userid?"":"visited"}));if(!p.userid&&e[0]){var n=T(e[0]);S(n)}},w=function(){clearTimeout(v);v=setTimeout(function(){var e=parseInt(g.innerHeight()+g.scrollTop());if(g.find("ul").height()-e<100){g.unbind("scroll");b()}},500)},C=function(){g.on("mouseenter","li",function(){var e=$(this),t=e.find(".close");t.show()}).on("mouseleave","li",function(){var e=$(this),t=e.find(".close");t.hide()}).on("click","li",function(e){var t=$(this);user=t.data("user");$(".letter-menu li").removeClass("visited");t.addClass("visited");S(user)}).on("click","li a.close",function(e){e.stopPropagation();var t=$(this).parent("li"),i=t.data("user");if(t.hasClass("visited")){var n=t.next("li");if(n&&n.length>0){n.click()}else{S({})}}t.remove();O(i.userid)})},T=function(e){var t=e;if(e.comment_info){t=e.comment_info.author;if(t.userid==a){t=e.source_info.author}}return t},I=function(e){if(!e||e.length==0){return 0}var t=e.find(".num").html()||0;return t},x=function(e,t){t=t||false;var i=$("#talk"+e,g);$num=i.find(".num");if(t){$num.remove();L(e);return}var n=I(i);if(n){i.find(".num").html(++n)}else{i.append('<span class="num">'+ ++n+"</span>")}var s=i.siblings().eq(0);i.insertBefore(s)},A=function(e){var t=$("#talk"+e,g);var i=I(t);if(i){return true}else{return false}};var S=function(e){p=e;if(e.userid){$(".talk-title span").html("与"+e.username+"的对话");h[e.userid]=h[e.userid]||{};h[e.userid].author=e;M(e.userid)}else{$(".talk-title span").html("");k.find("ul").empty();setTimeout(d,100)}n.clear(l)},M=function(e){h[e]=h[e]||{};k.find(".show-content-hook").hide().removeClass("show-content-hook");var t=k.find("#talkContent"+e);var i=A(e);if(h[e].load){t.addClass("show-content-hook").show();z()}else{D(e)}if(i){x(e,true)}},D=function(t,i){h[t]=h[t]||{};e.tingApi("baidu.ting.ugcmsg.recvMessage",{msg_type:2,size:20,msg_id:h[t].msg_id,timestamp:h[t].timestamp,dst_uid:t}).done(function(e){var n=e.result.content;var s=B(t,n,i);var a=e.result.last_msg;h[t].load=1;if(a){h[t].msg_id=a.msg_id;h[t].timestamp=a.ctime;h[t].havemore=e.result.havemore}if(!e.result.havemore){s.find(".more").hide()}else{s.find(".more").show()}if(!i){z()}}).fail(function(e){})},B=function(e,t,n){h[e]=h[e]||{};if(!h[e].ctime||t[t.length-1].ctime>h[e].ctime){if(t.length>0){h[e].ctime=t[t.length-1].ctime}}var s=h[e].load,r={list:t||{},userid:a,dst_uid:e,append:s};if(s){var o=k.find("#talkContent"+e);if(n){o.find("ul").prepend(i(r))}else{o.find("ul").append(i(r))}}else{var o=$(i(r)).appendTo(".talk-content-tmpl")}return o},L=function(e){var t={dst_uid:e,src_uid:a};N.markRead(t)},O=function(t){e.tingApi("baidu.ting.ugcmsg.delMessage",{msg_type:2,del_type:2,dst_uid:t})},q=function(){k.on("click",".more",function(){D(p.userid,true)}).on("click",".song-play-hook",function(){var e=$(this).data("songid"),t={moduleName:"playSong"};ting.media.playSong(e,t);self.tip().tip("tipup",{msg:"已开始播放",iconClass:"tip-success"})})},z=function(){var e=parseInt($(".talk-content").innerHeight());k.scrollTop(e)};if(other.userid&&other.userid>0){y([other],1)}b();C();q();var H=function(t,i){var n=t.src_uid==a?t.dst_uid:t.src_uid,s=!p.userid||n==p.userid;h[n]=h[n]||{};$.when($.Deferred(function(){var t=this;if(!h[n].author){e.getSpUserInfo(n).always(function(e){t.resolve(e)})}else{t.resolve(h[n].author)}}),$.Deferred(function(){var t=this;if(h[n].load){switch(parseInt(i.source_type)){case 0:e.tingApi("baidu.ting.song.baseInfo",{songid:i.source_id}).always(function(e){if(e&&e.content){t.resolve(e.content)}else{t.resolve()}});break;case 1:e.tingApi("baidu.ting.ugcdiy.getBaseInfo",{list_id:i.source_id,withsong:0,withcount:0}).always(function(e){if(e&&e.result){t.resolve(e.result.info)}else{t.resolve()}});break;case 2:e.tingApi("baidu.ting.album.getAlbumInfo",{album_id:i.source_id}).always(function(e){if(e&&e.albumInfo){t.resolve(e.albumInfo)}else{t.resolve()}});break;case 3:e.tingApi("baidu.ting.artist.getInfo",{tinguid:i.source_id}).always(function(e){if(e){t.resolve(e)}else{t.resolve()}});break;case 6:e.tingApi("baidu.ting.ugctopic.getDetail",{topicid:i.source_id,withinfo:1}).always(function(e){if(e&&e.topic_info){t.resolve(e.topic_info)}else{t.resolve()}});break;default:t.resolve();break}}else{t.resolve()}})).done(function(e,r){if(h[n].load){i.author=t.src_uid==a?myself:e;i.source=r;i.ctime=t.content_time||Math.floor((new Date).getTime()/1e3);i.ptime=h[n].ctime||0;var o=B(n,[i]);z()}var l=$("#talk"+n,g);if(!l||l.length==0){y([e])}if(!s){x(n);N.successCallBack.opt.setUnreadM.call(this)}else{if(t.serverid==10002){L(n)}}})},N=e.getWebChat({httpInterval:1e3,setLetter:function(e,t){var i=e.random_id,n=_.toString().indexOf(i);if(n>-1){_.splice(n,1)}else{t.random_id=i;H(e,t)}}})});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/