define(["core/utils","widget/pop_window/pop_window","tmpl/common/ushare/share_main","tmpl/common/ushare/share_search","tmpl/common/ushare/share_search_list","page/dynamic/publish","widget/toast/toast","http://static1.qianqian.com/web/static/j/plugin/qrcode.min"],function(e,o,a,n,i,r,s){var t={};var p={options:{}};var c=false;var l=false;var d="";var m={baseEl:$(".music-body"),innerSelect:".ushare-tmpl",shareParam:{bdText:"分享的内容",bdDesc:"分享的摘要",bdUrl:window.location.href,pageUrl:window.location.href,bdPic:""},apiParam:{userid:0,source_type:null,source_id:0},addNumCallBack:function(){},onlyLetter:false,onlyCommon:false};var u=function(e){t.options=$.extend(m,e);t.$base=t.options.baseEl;t.$ushareInner=$(t.options.innerSelect,t.$base);if(!t.$ushareInner||t.$ushareInner.length==0){t.$ushareInner=$('<div class="ushare-tmpl"></div>').appendTo(t.$base)}t.timeout=null;t.options.apiParam.source=null;switch(t.options.apiParam.source_type){case 0:t.options.apiParam.source=3;break;case 1:t.options.apiParam.source=0;break;case 2:t.options.apiParam.source=1;break;case 3:t.options.apiParam.source=2;break;case 5:t.options.apiParam.source=5;break}if(t.options.onlyLetter){b()}else if(t.options.onlyCommon){w(t.options.apiParam.source_type)}else{f()}p.options.innerSelect=".weixin-tmpl";p.$weixinInner=$(p.options.innerSelect);if(!p.$weixinInner||p.$weixinInner.length==0){p.$weixinInner=$('<div class="weixin-tmpl"></div>').appendTo($("body"))}p.popWindow=o.create({title:"分享到微信",baseEl:p.$weixinInner,offsetY:70,closeCallback:function(){o.hide(p.popWindow);$("body").removeClass("noFilter");$(".top-header-wrapper, .panel-singer, .common-pop-mask, .music-main, .vip-app, .vip-app-down-open, .music-foot").removeClass("blurred");o.hide(t.popWindow);return true}});o.hide(p.popWindow);v()};function h(){var e=navigator.userAgent;var o=e.indexOf("compatible")>-1&&e.indexOf("MSIE")>-1;var a=e.indexOf("Edge")>-1&&!o;var n=e.indexOf("Trident")>-1&&e.indexOf("rv:11.0")>-1;if(o){var i=new RegExp("MSIE (\\d+\\.\\d+);");i.test(e);var r=parseFloat(RegExp["$1"]);if(r==7){return 7}else if(r==8){return 8}else if(r==9){return 9}else if(r==10){return 10}else{return 6}}else if(a){return"edge"}else if(n){return 11}else{return-1}}var f=function(){t.popWindow=o.create({baseEl:t.$ushareInner,innerWidth:720,innerHeight:361,title:'<ul class="ushare-tab ushare-tab-hook">'+'<li><a href="javascript:;" class="visited" data-key="main">分享给大家</a></li>'+'<li><a href="javascript:;" data-key="search">私信分享</a></li>'+"</ul>",closeCallback:function(){$("body").removeClass("noFilter");$(".top-header-wrapper, .panel-singer, .common-pop-mask, .music-main, .vip-app, .vip-app-down-open, .music-foot").removeClass("blurred");return true}});o.hide(t.popWindow)},b=function(){t.popWindow=o.create({baseEl:t.$ushareInner,title:"私信分享",closeCallback:function(){$("body").removeClass("noFilter");$(".top-header-wrapper, .panel-singer, .common-pop-mask, .music-main, .vip-app, .vip-app-down-open, .music-foot").removeClass("blurred");o.hide(t.popWindow)}});o.hide(t.popWindow);I()},w=function(){t.popWindow=o.create({baseEl:t.$ushareInner,title:"分享给大家",closeCallback:function(){$("body").removeClass("noFilter");$(".top-header-wrapper, .panel-singer, .common-pop-mask, .music-main, .vip-app, .vip-app-down-open, .music-foot").removeClass("blurred");o.hide(t.popWindow)}});o.hide(t.popWindow);P()},P=function(n){var i="share_"+(new Date).getTime();if(h()==-1){$(".top-header-wrapper, .panel-singer, .common-pop-mask, .music-main, .vip-app, .vip-app-down-open, .music-foot").addClass("blurred")}else{$("body").addClass("noFilter")}l=false;if(t.options.apiParam.source_type==0&&!c){o.setContent(t.popWindow,a({tag:i,sourceType:"",common:t.options.onlyCommon,bdDesc:t.options.shareParam.bdDesc,pageUrl:location.href,bdPic:"",bdUrl:t.options.shareParam.bdUrl}));o.show(t.popWindow);e.tingApi("baidu.ting.song.sharePic",{from:"web",song_id:t.options.apiParam.source_id}).always(function(e){if(e.error_code==22e3){d=e.data.img;c=true}l=true;t.options.shareParam.bdPic=d||t.options.shareParam.bdPic;$(".leftimg-pic").addClass(d?"song":"").attr("src",t.options.shareParam.bdPic);x(i)}).fail(function(){l=true})}else{o.setContent(t.popWindow,a({tag:i,pageUrl:location.href,sourceType:t.options.apiParam.source_type==0&&d?"song":"",common:t.options.onlyCommon,bdDesc:t.options.shareParam.bdDesc,bdPic:d||t.options.shareParam.bdPic,bdUrl:t.options.shareParam.bdUrl}));o.show(t.popWindow);x(i);l=true}};loadSearchTmpl=function(e){e=e||{};if(e.type==4){t.$ushareInner.find(".search-list-tmpl").html(i(e))}else{l=true;o.setContent(t.popWindow,n(e))}};var v=function(){t.$ushareInner.off();t.$ushareInner.on("click",".ushare-tab-hook a",function(){var e=$(this).data("key");k(e)});$("body").on("click","#copylinkimg",function(){W()});g();y()},g=function(){r.init({baseEl:t.$base,apiParam:t.options.apiParam,callback:function(){}});t.$ushareInner.on("click",".icon-list a.dynamic-hook",function(){var e=$(this);if(!ting.userInfo){ting.passport.checkLogin(function(e){r.show();o.hide(t.popWindow)})}else{r.show();o.hide(t.popWindow)}if($(".jinlibang")){$(".common-pop-mask").hide();$(".common-pop-mask:last").show()}}).on("click",".icon-list a",function(){T()})},y=function(){var a=e.getWebChat({setLetter:function(e,o){T();s.show({data:{cls:"succ",text:"发送成功"}})}});t.$ushareInner.on("click",".share-login-hook",function(){o.hide(t.popWindow);ting.passport.login()});t.$ushareInner.on("propertychange input",".search-input input",function(){clearTimeout(t.timeout);var e=$(this);t.timeout=setTimeout(function(){_(e.val())},200)}).on("click",".letter-btn-hook",function(){var e=$(this).parent("li"),o=e.data("item");var n={msg:JSON.stringify({msg_type:2,source_id:t.options.apiParam.source_id,source_type:t.options.apiParam.source_type,op_type:0,content:""}),dst_uid:o.userid,serverid:10001,type:1};a.sentMessage(n)});t.$ushareInner.on("click","a.close",function(){o.hide(t.popWindow)})};var k=function(e){e=e||"main";$(".ushare-tab-hook a",t.$ushareInner).each(function(o,a){var n=$(a);if(n.data("key")==e){n.addClass("visited")}else{n.removeClass("visited")}});if(e=="main"){P()}else{I()}},C=function(o){var a=$.Deferred();e.tingApi("baidu.ting.ugcfriend.getFriendList",{size:50,query:o||""}).always(function(e){if(e&&e.list){a.resolve({list:e.list})}else{a.resolve({list:[]})}});return a.promise()},I=function(){if(!ting.passport.isLogin){loadSearchTmpl({type:1});return}else{C().done(function(e){if(e.list.length>0){loadSearchTmpl({type:3,list:e.list})}else{loadSearchTmpl({type:2})}})}},_=function(e){clearTimeout(t.timeout);e=$.trim(e);C(e).done(function(o){loadSearchTmpl({type:4,query:e,list:o.list})})},U=function(e,o){if(e.indexOf("from=")>-1){return}var a=e.split("#")[0];if(/\?/g.test(a)){if(/name=[-\w]{4,25}/g.test(a)){a=a.replace(/name=[-\w]{4,25}/g,"from="+o)}else{a+="&from="+o}}else{a+="?from="+o}if(e.split("#")[1]){e=a+"#"+e.split("#")[1]}else{e=a}t.options.shareParam.bdUrl=e},x=function(e){var a=t.options.shareParam.bdUrl;t.$ushareInner.off("click",".icon-list .shares-btn");t.$ushareInner.on("click",".icon-list .shares-btn",function(){if(!l){return false}var e=$(this).data("cmd");o.hide(t.popWindow);if(e!=="weixin"){$("body").removeClass("noFilter");$(".top-header-wrapper, .panel-singer, .common-pop-mask, .music-main, .vip-app, .vip-app-down-open, .music-foot").removeClass("blurred")}switch(e){case"weibo":var n=(t.options.shareParam.bdText||t.options.shareParam.bdDesc)+t.options.shareParam.bdUrl;n=n.replace("@千千音乐","@千千音乐官微");U(t.options.shareParam.bdUrl,"pcweb_mall_shareWeibo");url="http://service.weibo.com/share/share.php?appkey=3156384834?url="+encodeURIComponent(t.options.shareParam.bdUrl)+"&title="+encodeURIComponent(n)+"&from=rr&summary="+encodeURIComponent("")+"&pic="+t.options.shareParam.bdPic+"&content=utf-8";break;case"qzone":U(t.options.shareParam.bdUrl,"pcweb_mall_shareQzone");url="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?site=&url="+encodeURIComponent(t.options.shareParam.bdUrl)+"&title="+encodeURIComponent(t.options.shareParam.bdText)+"&desc="+encodeURIComponent(t.options.shareParam.bdDesc)+"&summary="+encodeURIComponent(t.options.shareParam.bdDesc)+"&pics="+t.options.shareParam.bdPic;break;case"qq":U(t.options.shareParam.bdUrl,"pcweb_mall_shareQQ");url="http://connect.qq.com/widget/shareqq/index.html?url="+encodeURIComponent(t.options.shareParam.bdUrl)+"&desc="+encodeURIComponent(t.options.shareParam.bdDesc)+"&title="+encodeURIComponent(t.options.shareParam.bdText)+"&summary="+encodeURIComponent(t.options.shareParam.bdDesc)+"&pics="+t.options.shareParam.bdPic+"&site=千千音乐&style=203&width=16&height=16";break;case"weixin":switch(t.options.apiParam.source_type){case 0:case 1:case 2:case 3:case 5:t.options.shareParam.bdUrl=a;break;default:t.options.shareParam.bdUrl="http://music.taihe.com/";break}U(t.options.shareParam.bdUrl,"pcweb_mall_shareWeixin");l=true;o.setContent(p.popWindow,'<div class="weixin-tip">微信扫描二维码，点击右上角 <i class="wx-icon"></i> 按钮<br/>分享给<i class="strong"> 好友 </i>或<i class="strong"> 朋友圈 </i></div><div id="qrcode-img"></div>');o.show(p.popWindow);var i=new QRCode("qrcode-img",{text:t.options.shareParam.bdUrl,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:1});url="";break;case"douban":url="http://www.douban.com/share/service?href="+encodeURIComponent(t.options.shareParam.bdUrl)+"&name="+encodeURIComponent(t.options.shareParam.bdText)+"&image="+t.options.shareParam.bdPic;break}if(url&&e!="weixin"){window.open(url,"_blank")}})},W=function(){var e=document.getElementById("copylinkimg");e.select();document.execCommand("copy",false,null);s.show({baseEl:$("body"),data:{cls:"succ",text:"已复制好，可贴粘。"}})},T=function(){e.tingApi("baidu.ting.ugcdiy.addCountNum",{type:"share",source:t.options.apiParam.source,list_id:t.options.apiParam.source==2?t.options.apiParam.artistid:t.options.apiParam.source_id}).done(function(){t.options.addNumCallBack.call(t)})};return{init:function(e){u(e)},initLetter:function(e){e.onlyLetter=true;u(e)},show:function(e){e=e||{};shareParam=e.shareParam||{};t.options.shareParam=$.extend(t.options.shareParam,shareParam);apiParam=e.apiParam||{};t.options.apiParam=$.extend(t.options.apiParam,apiParam);var o=t.options.onlyLetter?"search":"main";k(o)}}});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/