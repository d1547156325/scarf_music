define(["core/utils","tmpl/dynamic/dynamic","bind/sina","widget/pop_window/pop_window","widget/filed/filed","widget/toast/toast","page/dynamic/multiImg","page/dynamic/dynamicSug"],function(e,i,t,n,o,s,a,c){var d={};var r={baseEl:$("body"),apiParam:{source_type:null,source_id:0},innerSelect:".dynamic-publish-tmpl",callback:function(){}};var l=function(e){d.options=$.extend(r,e);d.$base=d.options.baseEl;d.popWindow=n.create({baseEl:d.options.baseEl,title:"发布动态",offsetY:70,closeCallback:y});n.hide(d.popWindow)};var p=function(e,i,t){s.show({innerSelect:".toast-tmpl",data:{cls:e,text:i},callback:t})},u=function(t,o){var s=$(i({isForwad:t,data:o,weiboNew:e.getCookie("_scd")}));n.setTitle(d.popWindow,t?"转发动态":"发布动态");n.setContent(d.popWindow,s);n.show(d.popWindow);if(!t){c.result(d.options.apiParam)}},f=function(){d.$dyInner=d.popWindow.$pop;d.$dyInner=d.$dyInner.eq(0);d.$editText=d.$dyInner.find(".textarea-hook")},m=function(i,n){d.msg_users=[];if(i){if(n.dparent){d.msg_users.push(n.dparent.user);if(n.dparent.msg_users){d.msg_users=d.msg_users.concat(n.dparent.msg_users)}}}d.$editText.focus();d.filed=o.init({baseEl:d.$dyInner});d.filed.$editText.on("add:user",function(e,i){v(i.userid,i.username)});d.filed.$editText.on("add:face",function(e,i){});d.filed.$editText.on("edit",function(e,i,t){b(i,t)});if(i&&i==2){o.setText(d.filed,"//@"+n.dparent.user.username+"："+n.dparent.msg_title);o.setFild(d.filed,0)}d.filed.$editText.on("send",function(t,o){var s=$(this);var a=s.val();var c=g(i,n);if(!c){return}var r=_(i);if(!r){return}var l={typeid:i?4:1,msg:a,msg_users:JSON.stringify(d.msg_users),msg_parent_id:i?n.dorigin.msg_id:0,msg_ori_id:i?n.dparent.msg_id:0};l=$.extend(l,c,r);e.tingApi("baidu.ting.ugcfriend.addMsgInfo",l,{type:"POST"}).done(function(e){p("succ","发送成功",function(){k();d.options.callback(e.new_message);var i=d.$dyInner.find(".sina-hook");if(i.hasClass("sina-select")){e.new_message.pic=l.pic;w(i.data("token"),e.new_message)}})}).fail(function(i){var t="发送失败";if(i){var n=e.getApiCode();switch(i.error_code){case n.USER_UNLOGIN:t="未检测登录状态";break;case n.CONTENT_HAVE_ANTI:t="内容含有黄反或敏感信息，请审查";break;case n.ACTION_FREQUENT:t="发送频繁，稍后再试";break;case n.USER_NO_PERMISSION:t="用户被封禁，禁止操作";break}}p("fail",t)});ting.logger.log("click",{page:"submit_button",pos:"fabu",sub:c.topic})});d.$imgWrap=a.init({baseEl:d.$dyInner});c.init({baseEl:d.$dyInner});d.$dyInner.find(".sina-hook").click(function(i){var n=$(this);if(n.hasClass("sina-select")){n.removeClass("sina-select");return}else{n.siblings("http://static4.qianqian.com/web/static/j/i.new").remove();e.setCookie("_scd","1")}t.checkAuth().done(function(e){n.addClass("sina-select");n.data("token",e)}).fail(function(){t.setAuth().done(function(){p("succ","授权成功");n.addClass("sina-select")})});ting.logger.log("click",{page:"sharetoweibo",pos:"zt"})});d.$dyInner.find("a.cancel").click(function(e){k()})},g=function(e,i){var t=c.$resultMusic.data("sug");if(!t&&!e){p("fail","还没添加音乐呢");return false}var n=0,o="";if(t&&t.type_3=="song"){o=0;n=t.item.song_id}else if(t&&t.type_3=="songlist"){o=1;n=t.item.list_id||t.item.diy_id}else if(t&&t.type_3=="album"){o=2;n=t.item.album_id}else if(t&&t.type_3=="artist"){o=3;n=t.item.ting_uid}else if(t&&t.type_3=="special"){o=5;n=t.item.specialid}var s=c.$resultTopic.data("sug");var a=0,d="";if(s&&s.type_3=="topic"){a=s.item.topic_id;d=s.item.topic_title}else if(s&&s.type_3=="new"){d=s.item.topic_title}if(e&&i.dorigin&&i.dorigin.topic_id){a=i.dorigin.topic_id;d=i.dorigin.topic_title}return{content_type:o,content_id:n,topicid:a,topic:d}},_=function(){var e=[];d.$imgWrap.find("ul li").each(function(){var i=$(this).data("file");if(i){e.push(i)}});return{pic:e.join(",")}},b=function(e,i){var t=500;var n=t-i.length,o=this;if(n<0){d.$editText.attr("readonly","readonly");s.show({innerSelect:".toast-tmpl",data:{cls:"fail",text:"超过"+t+"字了，太多啦"},callback:function(){d.$editText.removeAttr("readonly");d.$editText.val(i.substr(0,t))}})}},v=function(e,i){d.msg_users.push({userid:e,username:i})},y=function(){var e=d.filed.$editText.val();var i=g(100,{});var t=_();if(e==""&&i.content_id==0&&i.topicid==0&&t.pic==""){return true}d.delWindow=n.create({baseEl:d.$base,spPop:true,title:"是否退出此次编辑",text:{btnText:"退出"},callback:function(){n.hide(d.delWindow);n.hide(d.popWindow);removeFilter()}});return false},w=function(e,i){var n={topic:{id:0,text:""},song:0,album:0,artist:0,songlist:0,msg:i.msg,pic:i.pic};if(i.topic&&i.topic.topic_id>0){n.topic.id=i.topic.topic_id;n.topic.text=i.topic.topic_title}if(i.content&&i.content.content_id>0){switch(i.content.content_type){case 0:n.song=i.content.content_id;break;case 1:n.songlist=i.content.content_id;break;case 2:n.album=i.content.content_id;break;case 3:n.artist=i.content.tinguid;break;case 5:n.special=i.content.content_id}}t.sendContent(e,n)},h=function(e,i){u(e,i);f();m(e,i)},k=function(){n.hide(d.popWindow);removeFilter()};removeFilter=function(){$("body").removeClass("noFilter");$(".top-header-wrapper, .panel-singer, .common-pop-mask, .music-main, .vip-app, .vip-app-down-open, .music-foot").removeClass("blurred")};d.init=function(e){l(e)};d.show=function(e,i){e=typeof e=="undefined"?0:e;i=i||{};h(e,i)};return d});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/