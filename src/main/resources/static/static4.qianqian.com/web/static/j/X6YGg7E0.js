(function(e){e.fn.dragsort=function(t){if(t=="destroy"){e(this.selector).trigger("dragsort-uninit");return}var r=e.extend({},e.fn.dragsort.defaults,t);var o=[];var a=null,i=null;this.each(function(t,l){if(e(l).is("table")&&e(l).children().size()==1&&e(l).children().is("tbody"))l=e(l).children().get(0);var s={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:l,init:function(){var o=e(this.container).children().size()==0?"li":e(this.container).children(":first").get(0).tagName.toLowerCase();if(r.itemSelector=="")r.itemSelector=o;if(r.dragSelector=="")r.dragSelector=o;if(r.placeHolderTemplate=="")r.placeHolderTemplate="<"+o+">&nbsp;</"+o+">";e(this.container).attr("data-listidx",t).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit);this.styleDragHandlers(true)},uninit:function(){var t=o[e(this).attr("data-listidx")];e(t.container).unbind("mousedown",t.grabItem).unbind("dragsort-uninit");t.styleDragHandlers(false)},getItems:function(){return e(this.container).children(r.itemSelector)},styleDragHandlers:function(t){this.getItems().map(function(){return e(this).is(r.dragSelector)?this:e(this).find(r.dragSelector).get()}).css("cursor",t?"pointer":"")},grabItem:function(t){if(t.which!=1||e(t.target).is(r.dragSelectorExclude)||e(t.target).closest(r.dragSelectorExclude).size()>0||e(t.target).closest(r.itemSelector).size()==0)return;t.preventDefault();var a=t.target;while(!e(a).is(r.dragSelector)){if(a==this)return;a=a.parentNode}e(a).attr("data-cursor",e(a).css("cursor"));e(a).css("cursor","move");var i=o[e(this).attr("data-listidx")];var l=this;var s=function(){i.dragStart.call(l,t);e(i.container).unbind("mousemove",s)};e(i.container).mousemove(s).mouseup(function(){e(i.container).unbind("mousemove",s);e(a).css("cursor",e(a).attr("data-cursor"))})},dragStart:function(t){if(a!=null&&a.draggedItem!=null)a.dropItem();a=o[e(this).attr("data-listidx")];a.draggedItem=e(t.target).closest(r.itemSelector);a.draggedItem.attr("data-origpos",e(this).attr("data-listidx")+"-"+a.getItems().index(a.draggedItem));var i=parseInt(a.draggedItem.css("marginTop"));var l=parseInt(a.draggedItem.css("marginLeft"));a.offset=a.draggedItem.offset();a.offset.top=t.pageY-a.offset.top+(isNaN(i)?0:i)-1;a.offset.left=t.pageX-a.offset.left+(isNaN(l)?0:l)-1;if(!r.dragBetween){var s=e(a.container).outerHeight()==0?Math.max(1,Math.round(.5+a.getItems().size()*a.draggedItem.outerWidth()/e(a.container).outerWidth()))*a.draggedItem.outerHeight():e(a.container).outerHeight();a.offsetLimit=e(a.container).offset();a.offsetLimit.right=a.offsetLimit.left+e(a.container).outerWidth()-a.draggedItem.outerWidth();a.offsetLimit.bottom=a.offsetLimit.top+s-a.draggedItem.outerHeight()}var n=a.draggedItem.height();var d=a.draggedItem.width();if(r.itemSelector=="tr"){a.draggedItem.children().each(function(){e(this).width(e(this).width())});a.placeHolderItem=a.draggedItem.clone().attr("data-placeholder",true);a.draggedItem.after(a.placeHolderItem);a.placeHolderItem.children().each(function(){e(this).css({borderWidth:0,width:e(this).width()+1,height:e(this).height()+1}).html("&nbsp;")})}else{a.draggedItem.after(r.placeHolderTemplate);a.placeHolderItem=a.draggedItem.next().css({height:n,width:d}).attr("data-placeholder",true)}if(r.itemSelector=="td"){var c=a.draggedItem.closest("table").get(0);e("<table id='"+c.id+"' style='border-width: 0px;' class='dragSortItem "+c.className+"'><tr></tr></table>").appendTo("body").children().append(a.draggedItem)}var g=a.draggedItem.attr("style");a.draggedItem.attr("data-origstyle",g?g:"");a.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:n,width:d});a.scroll={moveX:0,moveY:0,maxX:e(document).width()-e(window).width(),maxY:e(document).height()-e(window).height()};a.scroll.scrollY=window.setInterval(function(){if(r.scrollContainer!=window){e(r.scrollContainer).scrollTop(e(r.scrollContainer).scrollTop()+a.scroll.moveY);return}var t=e(r.scrollContainer).scrollTop();if(a.scroll.moveY>0&&t<a.scroll.maxY||a.scroll.moveY<0&&t>0){e(r.scrollContainer).scrollTop(t+a.scroll.moveY);a.draggedItem.css("top",a.draggedItem.offset().top+a.scroll.moveY+1)}},10);a.scroll.scrollX=window.setInterval(function(){if(r.scrollContainer!=window){e(r.scrollContainer).scrollLeft(e(r.scrollContainer).scrollLeft()+a.scroll.moveX);return}var t=e(r.scrollContainer).scrollLeft();if(a.scroll.moveX>0&&t<a.scroll.maxX||a.scroll.moveX<0&&t>0){e(r.scrollContainer).scrollLeft(t+a.scroll.moveX);a.draggedItem.css("left",a.draggedItem.offset().left+a.scroll.moveX+1)}},10);e(o).each(function(e,t){t.createDropTargets();t.buildPositionTable()});a.setPos(t.pageX,t.pageY);e(document).bind("mousemove",a.swapItems);e(document).bind("mouseup",a.dropItem);if(r.scrollContainer!=window)e(window).bind("DOMMouseScroll mousewheel",a.wheel)},setPos:function(t,o){var i=o-this.offset.top;var l=t-this.offset.left;if(!r.dragBetween){i=Math.min(this.offsetLimit.bottom,Math.max(i,this.offsetLimit.top));l=Math.min(this.offsetLimit.right,Math.max(l,this.offsetLimit.left))}this.draggedItem.parents().each(function(){if(e(this).css("position")!="static"&&(!e.browser.mozilla||e(this).css("display")!="table")){var t=e(this).offset();i-=t.top;l-=t.left;return false}});if(r.scrollContainer==window){o-=e(window).scrollTop();t-=e(window).scrollLeft();o=Math.max(0,o-e(window).height()+5)+Math.min(0,o-5);t=Math.max(0,t-e(window).width()+5)+Math.min(0,t-5)}else{var s=e(r.scrollContainer);var n=s.offset();o=Math.max(0,o-s.height()-n.top)+Math.min(0,o-n.top);t=Math.max(0,t-s.width()-n.left)+Math.min(0,t-n.left)}a.scroll.moveX=t==0?0:t*r.scrollSpeed/Math.abs(t);a.scroll.moveY=o==0?0:o*r.scrollSpeed/Math.abs(o);this.draggedItem.css({top:i,left:l})},wheel:function(t){if((e.browser.safari||e.browser.mozilla)&&a&&r.scrollContainer!=window){var o=e(r.scrollContainer);var i=o.offset();if(t.pageX>i.left&&t.pageX<i.left+o.width()&&t.pageY>i.top&&t.pageY<i.top+o.height()){var l=t.detail?t.detail*5:t.wheelDelta/-2;o.scrollTop(o.scrollTop()+l);t.preventDefault()}}},buildPositionTable:function(){var t=[];this.getItems().not([a.draggedItem[0],a.placeHolderItem[0]]).each(function(r){var o=e(this).offset();o.right=o.left+e(this).outerWidth();o.bottom=o.top+e(this).outerHeight();o.elm=this;t[r]=o});this.pos=t},dropItem:function(){if(a.draggedItem==null)return;var t=a.draggedItem.attr("data-origstyle");a.draggedItem.attr("style",t);if(t=="")a.draggedItem.removeAttr("style");a.draggedItem.removeAttr("data-origstyle");a.styleDragHandlers(true);a.placeHolderItem.before(a.draggedItem);a.placeHolderItem.remove();e("[data-droptarget], .dragSortItem").remove();window.clearInterval(a.scroll.scrollY);window.clearInterval(a.scroll.scrollX);if(a.draggedItem.attr("data-origpos")!=e(o).index(a)+"-"+a.getItems().index(a.draggedItem))r.dragEnd.apply(a.draggedItem);a.draggedItem.removeAttr("data-origpos");a.draggedItem=null;e(document).unbind("mousemove",a.swapItems);e(document).unbind("mouseup",a.dropItem);if(r.scrollContainer!=window)e(window).unbind("DOMMouseScroll mousewheel",a.wheel);return false},swapItems:function(t){var l=require("page/songlist/songlist_edit");l._drag(t);if(a.draggedItem==null)return false;a.setPos(t.pageX,t.pageY);var s=a.findPos(t.pageX,t.pageY);var n=a;for(var d=0;s==-1&&r.dragBetween&&d<o.length;d++){s=o[d].findPos(t.pageX,t.pageY);n=o[d]}if(s==-1)return false;var c=function(){return e(n.container).children().not(n.draggedItem)};var g=c().not(r.itemSelector).each(function(e){this.idx=c().index(this)});if(i==null||i.top>a.draggedItem.offset().top||i.left>a.draggedItem.offset().left)e(n.pos[s].elm).before(a.placeHolderItem);else e(n.pos[s].elm).after(a.placeHolderItem);g.each(function(){var t=c().eq(this.idx).get(0);if(this!=t&&c().index(this)<this.idx)e(this).insertAfter(t);else if(this!=t)e(this).insertBefore(t)});e(o).each(function(e,t){t.createDropTargets();t.buildPositionTable()});i=a.draggedItem.offset();return false},findPos:function(e,t){for(var r=0;r<this.pos.length;r++){if(this.pos[r].left<e&&this.pos[r].right>e&&this.pos[r].top<t&&this.pos[r].bottom>t)return r}return-1},createDropTargets:function(){if(!r.dragBetween)return;e(o).each(function(){var t=e(this.container).find("[data-placeholder]");var o=e(this.container).find("[data-droptarget]");if(t.size()>0&&o.size()>0)o.remove();else if(t.size()==0&&o.size()==0){if(r.itemSelector=="td")e(r.placeHolderTemplate).attr("data-droptarget",true).appendTo(this.container);else e(this.container).append(a.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",true));a.placeHolderItem.attr("data-placeholder",true)}})}};s.init();o.push(s)});return this};e.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:false,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}})(jQuery);

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/