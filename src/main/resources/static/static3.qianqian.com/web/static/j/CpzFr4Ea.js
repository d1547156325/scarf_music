define(["core/utils","muplayer/bmPlayer","tmpl/dynamic/sug","tmpl/dynamic/sugInput","tmpl/dynamic/sugTab","tmpl/dynamic/sugResult","widget/toast/toast"],function(utils,BmPlayer,sugTmpl,sugInputTmpl,sugTabTmpl,sugResultTmpl,toastPlugin){var dynamicSug={};dynamicSug.SUG_CONF={music_default_song:{type_1:"music",type_2:"default",type_3:"song",load:"loadMDSTmpl"},music_default_songlist:{type_1:"music",type_2:"default",type_3:"songlist",load:"loadMDSLTmpl"},music_search_song:{type_1:"music",type_2:"search",type_3:"song",load:"switchMSSTmpl"},music_search_album:{type_1:"music",type_2:"search",type_3:"album",load:"switchMSALTmpl"},music_search_artist:{type_1:"music",type_2:"search",type_3:"artist",load:"switchMSARTmpl"},music_search_songlist:{type_1:"music",type_2:"search",type_3:"songlist",load:"switchMSSLTmpl"},music_special:{type_1:"music",type_2:"",type_3:"special",load:""},topic_default_topic:{type_1:"topic",type_2:"default",type_3:"topic",load:""},topic_search_topic:{type_1:"topic",type_2:"search",type_3:"topic",load:""},topic_search_new:{type_1:"topic",type_2:"search",type_3:"new",load:""}};var _options={baseEl:$("body"),sugEl:null,resultMusicEl:null,resultTopicEl:null};var _init=function(i){dynamicSug.options=$.extend(_options,i);dynamicSug.$base=dynamicSug.options.baseEl;dynamicSug.$sugWrap=$(".dynamic-edit-sug",dynamicSug.$base);dynamicSug.$sugContent=$(".dynamic-edit-sug-content",dynamicSug.$base);dynamicSug.$resultMusic=$(".dynamic-edit-music-tmpl",dynamicSug.$base);dynamicSug.$resultTopic=$(".dynamic-edit-topic-tmpl",dynamicSug.$base);dynamicSug.timeout=null;dynamicSug.tmplTimeout=null;dynamicSug.SUG_DATA={type:{type_1:"",type_2:"",type_3:""},list:null};dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_DATA.type;_initPlayer();_bindEvent()},_initPlayer=function(){dynamicSug.player=new BmPlayer({baseDir:"/static/js/plugin/muplayer",loggerArgs:{data:{pid:"304",ref:"musicweb",from:"web"},api:"web"},engines:[{type:"AudioCore"},{type:"FlashMP4Core"},{type:"FlashMP3Core"}]})},_bindEvent=function(){dynamicSug.$base.off("click",".add-music-hook").off("click",".add-topic-hook");dynamicSug.$base.on("click",".add-music-hook",function(){var i=$(this);loadMDSTmpl(true);dynamicSug.$sugContent.removeClass("topic-content");wrapShow(i)}).on("click",".add-topic-hook",function(){var i=$(this);loadTDTmpl(true);dynamicSug.$sugContent.addClass("topic-content");wrapShow(i)});dynamicSug.$sugWrap.on("click","a.close",function(){wrapHidden()});dynamicSug.$sugContent.on("click",".tab-hook",function(){var tab=$(this).data("tab");eval(tab.load+"()")});var noinput=true;dynamicSug.$sugContent.on("input propertychange",".sug-input input",function(){noinput=false;clearTimeout(dynamicSug.timeout);var i=$(this);dynamicSug.timeout=setTimeout(function(){inputChange(i.val())},200)}).on("keyup",".sug-input input",function(){if(noinput){clearTimeout(dynamicSug.timeout);var i=$(this);dynamicSug.timeout=setTimeout(function(){inputChange(i.val())},200)}});dynamicSug.$sugContent.on("click",".sug-list ul li",function(){var i=$(this).data("item");if(i.topic_title&&i.topic_title.length>20){toastPlugin.show({data:{cls:"fail",text:"话题最多输入20字哦"}});return}sugResult(i);wrapHidden()}).on("click",".sug-list ul li .song-play-hook",function(){var i=$(this);if(i.hasClass("song-pause-hook")){playStop()}else{playStart(i)}return false});dynamicSug.$resultMusic.on("click",".song-play-hook",function(){var i=$(this);if(i.hasClass("song-pause-hook")){playStop()}else{playStart(i)}return false}).on("click",".link",function(i){i.stopPropagation()});dynamicSug.$resultTopic.on("click",".topic-remove-hook",function(){dynamicSug.$resultTopic.html(sugResultTmpl({type_1:"topic"}));dynamicSug.$resultTopic.attr("data-sug","");return false}).on("click",".link",function(i){i.stopPropagation()})},sugResult=function(i){var t=$.extend(dynamicSug.OLD_SUG_DATA,{item:i});if(dynamicSug.OLD_SUG_DATA.type_1=="music"){dynamicSug.$resultMusic.html(sugResultTmpl(t));dynamicSug.$resultMusic.data("sug",t)}else{dynamicSug.$resultTopic.html(sugResultTmpl(t));dynamicSug.$resultTopic.data("sug",t)}};wrapShow=function(i){var t=0,u=-26;if(dynamicSug.$base.css("position")=="absolute"||dynamicSug.$base.css("position")=="fixed"){u=u+dynamicSug.$base.offset().top;t=t+dynamicSug.$base.offset().left}dynamicSug.$sugWrap.css({top:i.offset().top-u+"px"}).show()},wrapHidden=function(){playStop(true);dynamicSug.$sugWrap.hide()},inputChange=function(i){clearTimeout(dynamicSug.timeout);i=$.trim(i);var t=!!(i=="");if(dynamicSug.OLD_SUG_DATA.type_1=="music"){if(t){loadMDSTmpl()}else{loadMSTmpl(i)}}else{if(t){loadTDTmpl()}else{loadTSTmpl(i)}}},playStart=function(i){playStop();var t=i.data("songid");dynamicSug.player.setCur(t).play();i.addClass("pause").addClass("song-pause-hook")},playStop=function(i){i=typeof i=="undefined"?false:i;var t=dynamicSug.$resultMusic.find(".song-pause-hook"),u=dynamicSug.$sugContent.find(".song-pause-hook");if(i){if(u.length>0){dynamicSug.player.stop()}u.removeClass("pause").removeClass("song-pause-hook")}else{dynamicSug.player.stop();u.removeClass("pause").removeClass("song-pause-hook");t.removeClass("pause").removeClass("song-pause-hook")}};var loadSugTmpl=function(i,t,u,a){clearTimeout(dynamicSug.tmplTimeout);dynamicSug.tmplTimeout=setTimeout(function(){},100);var t=t||1,a=typeof a=="undefined"?true:a,u=typeof u=="undefined"?true:u,n=false,e=dynamicSug.SUG_DATA.type;var s=$.extend(dynamicSug.SUG_DATA,{conf:dynamicSug.SUG_CONF,list:i||{}});if(dynamicSug.OLD_SUG_DATA.type_1==e.type_1&&dynamicSug.OLD_SUG_DATA.type_2==e.type_2){a=false}if(a){dynamicSug.$sugContent.find(".sug-input-tmpl").html(sugInputTmpl(s));dynamicSug.$sugContent.find(".sug-input input").focus()}if(dynamicSug.OLD_SUG_DATA.type_1==e.type_1&&dynamicSug.OLD_SUG_DATA.type_2==e.type_2&&dynamicSug.OLD_SUG_DATA.type_3==e.type_3){u=false;n=true}if(u){dynamicSug.$sugContent.find(".sug-tab-tmpl").html(sugTabTmpl(s))}var c=function(t){var u=dynamicSug.SUG_DATA.type.type_1+"-"+dynamicSug.SUG_DATA.type.type_2+"-"+dynamicSug.SUG_DATA.type.type_3;var a=$old=dynamicSug.$sugContent.find(".sug-list-tmpl ."+u+"-hook");if(i){if($old.length>0){$old.remove()}a=$(sugTmpl(s)).css({display:"none"});dynamicSug.$sugContent.find(".sug-list-tmpl").append(a)}if(t||n){var u=dynamicSug.OLD_SUG_DATA.type_1+"-"+dynamicSug.OLD_SUG_DATA.type_2+"-"+dynamicSug.OLD_SUG_DATA.type_3;var e=dynamicSug.$sugContent.find(".sug-list-tmpl ."+u+"-hook");if(e.length>0){e.hide()}a.show();dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_DATA.type}};switch(parseInt(t)){case 1:dynamicSug.$sugContent.find(".sug-list-tmpl").html(sugTmpl(s));dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_DATA.type;break;case 2:c(false);break;case 3:c(true);break;default:dynamicSug.$sugContent.find(".sug-list-tmpl").empty();dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_DATA.type}};var loadMDSTmpl=function(i){if(i){dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_default_song;loadSugTmpl([],1,true,true)}utils.tingApi("baidu.ting.favorite.getListenHistory",{rn:100}).always(function(i){var t=[];if(i&&i.result){for(var u in i.result.songlist){if(u!="content"){t.push(i.result.songlist[u])}}}dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_default_song;loadSugTmpl(t,3,true,false)})},loadMDSLTmpl=function(){utils.tingApi("baidu.ting.ugcdiy.userList",{source:0,type:10,size:100,offset:0}).always(function(i){var t=[];if(i&&i.result){t=i.result.listinfo}dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_default_songlist;loadSugTmpl(t,3)})},loadMSTmpl=function(i){var t=[],u=[],a=[],n=[];utils.tingApi("baidu.ting.search.merge",{query:i,page_size:10,type:"0,1,2,10",isNew:1}).done(function(i){if(i&&i.result.song_info){t=i.result.song_info.song_list}dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_song;if(dynamicSug.OLD_SUG_DATA.type_1==dynamicSug.SUG_DATA.type.type_1&&dynamicSug.OLD_SUG_DATA.type_2!=dynamicSug.SUG_DATA.type.type_2){loadSugTmpl(t,3,true,false,false)}else{loadSugTmpl(t,2,false)}if(i&&i.result.album_info){u=i.result.album_info.album_list}dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_album;loadSugTmpl(u,2,false);if(i&&i.result.artist_info){a=i.result.artist_info.artist_list}dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_artist;loadSugTmpl(a,2,false);if(i&&i.result.playlist_info){n=i.result.playlist_info.play_list}dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_songlist;loadSugTmpl(n,2,false)}).fail(function(i){})},switchMSSTmpl=function(){dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_song;loadSugTmpl(null,3)},switchMSALTmpl=function(){dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_album;loadSugTmpl(null,3)},switchMSARTmpl=function(){dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_artist;loadSugTmpl(null,3)},switchMSSLTmpl=function(){dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.music_search_songlist;loadSugTmpl(null,3)};var loadTDTmpl=function(i){dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.topic_default_topic;loadSugTmpl([],1,true,true);utils.tingApi("baidu.ting.ugctopic.getRecList",{typeid:3}).always(function(i){var t=[];if(i&&i.topics){t=i.topics}dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.topic_default_topic;loadSugTmpl(t,3,true,false)})},loadTSTmpl=function(i){utils.tingApi("baidu.ting.ugctopic.getSuggestions",{query:i}).always(function(t){var u=[];if(t&&t.topics){u=t.topics}if(u.length<1){u=[{topic_title:i}];dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.topic_search_new}else{dynamicSug.SUG_DATA.type=dynamicSug.SUG_CONF.topic_search_topic}loadSugTmpl(u,3,true,false)})};dynamicSug.init=function(i){_init(i)};dynamicSug.result=function(i){if(i&&i.source_id){switch(i.source_type){case 0:utils.tingApi("baidu.ting.song.baseInfo",{songid:i.source_id}).done(function(i){dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_CONF.music_search_song;sugResult(i.content)});break;case 1:utils.tingApi("baidu.ting.ugcdiy.getBaseInfo",{list_id:i.source_id,withsong:0,withcount:0}).done(function(i){dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_CONF.music_search_songlist;sugResult(i.result.info)});break;case 2:utils.tingApi("baidu.ting.album.getAlbumInfo",{album_id:i.source_id}).always(function(i){if(i&&i.albumInfo){dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_CONF.music_search_album;sugResult(i.albumInfo)}});break;case 3:utils.tingApi("baidu.ting.artist.getInfo",{tinguid:i.source_id}).always(function(i){if(i){dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_CONF.music_search_artist;sugResult(i)}});break;case 5:utils.tingApi("baidu.ting.ugcspecial.getSpecialInfo",{specialid:i.source_id}).done(function(i){dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_CONF.music_special;sugResult(i.result.specialInfo)});break;case 6:utils.tingApi("baidu.ting.ugctopic.getDetail",{topicid:i.source_id,withinfo:1}).done(function(i){dynamicSug.OLD_SUG_DATA=dynamicSug.SUG_CONF.topic_search_topic;sugResult(i.topic_info)});break;default:break}}};return dynamicSug});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/