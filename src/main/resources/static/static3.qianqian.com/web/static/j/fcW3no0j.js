define(["core/utils","bind/sina","widget/pop_window/pop_window","plugin/jquery.cityselect","plugin/birthday","widget/toast/toast","plugin/jquery.imgareaselect","http://static3.qianqian.com/web/static/j/plugin/jquery.form"],function(utils,BSina,popWindow,cityselect,birthday,toastPlugin){var opt={$tab:null,$set:null,hasGetEdit:false,hasGetSecret:false,hasGetBind:false};var loadToastTmpl=function(e,t,i){toastPlugin.show({innerSelect:".toast-tmpl",data:{cls:e,text:t},callback:i})};var common_event=function(){$(".user-set-tab").on("click","a",function(){var $self=$(this),set=$self.data("set"),action=$self.data("action");eval("init_"+action+"()");opt.$tab.removeClass("tab-current");opt.$tab=$self;opt.$tab.addClass("tab-current");opt.$set.hide();opt.$set=$("."+set).eq(0);opt.$set.show()})};var init_edit=function(){if(opt.hasGetEdit){return}edit_event();opt.hasGetEdit=true},edit_event=function(){var pageCurrentNum=1,allowScroll=true,pageTurn=false,mixControl="",$cutControlTip=$(".cut-control-tip"),$editDesc=$(".edit-desc"),$descText=$(".desc-text"),$editTagsBox=$(".edit-tags-box"),$editTagMore=$(".edit-tag-more"),$editSelectTagTips=$(".edit-select-tags-tips"),$removeThisTagBtn=$(".remove-this-tag-btn"),$submitBtn=$(".songlist-edit-submit"),$editCover=$(".edit-cover-preview"),selectedTagsArr=[],allTagsArr=[],ulOffSetTop=0,editNameMax=24,editNameMin=2,editDescMax=140,ulScrollTimer="",cut={uploadImg:{},preview:280,previewMini:160,mix:100,allowUpload:true},$editDetailBox=$(".edit-detail-box"),$editName=$(".edit-name"),$nickText=$(".nick-text"),nickRe=/^(\w|\d|-|[\u4e00-\u9fa5]){2,24}$/,$prov=$(".prov"),$city=$(".city"),$nickErrorText=$(".nick-error-text"),$descErrorText=$(".desc-error-text"),init=function(){editCoverPop=popWindow.create({title:"更改封面",offsetY:-70,closeCallback:function(){$("#ferret").imgAreaSelect({remove:true});initImgAreaSelect();return true}});popWindow.setContent(editCoverPop,$(".pop-edit-cover").show());popWindow.hide(editCoverPop);$nickText.html(editNameMax-$editName.val().length);$descText.html(editDescMax-$editDesc.val().length)},tagInit=function(){$editSelectTagTips.find("a").each(function(e){var t=$(this).text();$editTagsBox.find("a").each(function(e){if($(this).text()===t){$(this).addClass("selected")}})})};$editDesc.keyup(function(){var e=$(this);var t=e.val();if(t.length>editDescMax){e.addClass("red-border");$descText.html(editDescMax-t.length).addClass("red")}else{e.removeClass("red-border");$descText.html(editDescMax-t.length).removeClass("red")}});$editDesc.focus(function(){$(this).attr("placeholder","")});$editName.change(function(){var e=$(this);var t=e.val();var i={nickname:t};if(!t||$.trim(t)==""){$nickErrorText.html("昵称不能为空").addClass("red");$editName.attr("nick",false)}$editName.attr("nick",true);utils.tingApi("baidu.ting.ugccenter.checkNickName",i).done(function(e){if(e.error_code!=22e3){$nickErrorText.html("昵称已经被占用啦").addClass("red")}}).fail(function(e){})});$editName.blur(function(){var e=$(this);var t=e.val();if(!t||$.trim(t)==""){$editName.attr("nick",false);e.addClass("red-border");$nickErrorText.html("昵称不能为空").addClass("red")}if(t.length<editNameMin||t.length>editNameMax||!nickRe.test(t)){$editName.attr("nick",false).addClass("red-border");$nickErrorText.html("昵称需在2-24个字之间, 可以包含英文字母、中文、-、_、数字").addClass("red");return false}});$editName.focus(function(){var e=$(this);e.removeClass("red-border");$nickErrorText.html("").removeClass("red")});$editName.keyup(function(){var e=$(this);var t=e.val();if(t.length>editNameMax){e.addClass("red-border");$nickText.html(editNameMax-t.length).addClass("red");$nickErrorText.html("昵称需在2-24个字之间, 可以包含英文字母、中文、-、_、数字").addClass("red");$editName.attr("nick",false)}else{$editName.attr("nick",true);e.removeClass("red-border");$nickText.html(editNameMax-t.length).removeClass("red");$nickErrorText.html("").removeClass("red")}});$editTagMore.toggle(function(){editTagsBoxScrollHeight=$editTagsBox[0].scrollHeight-77;$editTagsBox.animate({height:editTagsBoxScrollHeight},500,function(){$editTagMore.html("- 收起");$(".edit-tags-hot").fadeOut(500)});tagInit()},function(){$editTagsBox.animate({height:45},300,function(){$editTagMore.html("+ 展开");$(".edit-tags-hot").fadeIn(500)});tagInit()});tagInit();$editTagsBox.find("a").live("click",function(){var e=$(this);if(e.hasClass("selected")){var t=e.text();e.removeClass("selected");$editSelectTagTips.find("a").each(function(e){if($(this).text()===t){$(this).remove()}});return false}if($editSelectTagTips.find("a").length>=5){loadToastTmpl("fail","最多选择五个口味分类！");return false}if($editSelectTagTips.find("a").length===0){$editSelectTagTips.html("")}$(this).addClass("selected");var i=$(this).clone();$editSelectTagTips.append(i.addClass("selected").append('<i class="remove-this-tag-btn t"></i>'))});$removeThisTagBtn.live("click",function(){var e=$(this).closest("a");$editTagsBox.find("a").each(function(t){if(e.text()===$(this).text()){$(this).removeClass("selected")}});e.remove();if($editSelectTagTips.find("a").length===0){$editSelectTagTips.html("选择五个音乐口味，让歌曲推荐更准确")}});$(".songlist-edit-cover-btn").click(function(){popWindow.show(editCoverPop)});$cutControlTip.html("不能小于"+cut.mix+"*"+cut.mix);function preview(e,t){var i=cut.previewMini/(t.width||1);var a=cut.previewMini/(t.height||1);$(".upload-img").css({width:Math.round(i*cut.uploadImg._width)+"px",height:Math.round(a*cut.uploadImg._height)+"px","margin-left":"-"+Math.round(i*t.x1)+"px","margin-top":"-"+Math.round(a*t.y1)+"px"})}function getFileUrl(e){var t=null;if(window.createObjectURL!=undefined){t=window.createObjectURL(e)}else if(window.URL!=undefined){t=window.URL.createObjectURL(e)}else if(window.webkitURL!=undefined){t=window.webkitURL.createObjectURL(e)}return t}$(".select-pic").change(function(){var e=this,t="";var i=$('<img src=""/>');i.css({position:"absolute",left:"0",top:"0",visibility:"hidden","z-index":"1"});$("body").append(i);var a=function(e){cut.uploadImg.height=i.height();cut.uploadImg.width=i.width();i.remove();var t=Math.max(cut.uploadImg.height,cut.uploadImg.width);if(cut.uploadImg.width===t){cut.uploadImg._height=cut.uploadImg.height*cut.preview/cut.uploadImg.width;cut.uploadImg._width=cut.preview;cut.uploadImg._top=(cut.preview-cut.uploadImg._height)/2;cut.uploadImg._left=0}else{cut.uploadImg._width=cut.uploadImg.width*cut.preview/cut.uploadImg.height;cut.uploadImg._height=cut.preview;cut.uploadImg._left=(cut.preview-cut.uploadImg._width)/2;cut.uploadImg._top=0}$("#ferret").css({width:cut.uploadImg._width+"px",height:cut.uploadImg._height+"px",top:cut.uploadImg._top+"px",left:cut.uploadImg._left+"px"});e(cut)};i.load(function(){$(".upload-tip").show();a(function(){$("#ferret").attr("src",t);$(".upload-img").attr("src",t)})});if($.browser.msie){try{t=getFileUrl(e.files[0]);i.attr("src",t)}catch(o){e.select();if(top!=e){window.parent.document.body.focus()}else{e.blur()}t=document.selection.createRange().text;document.selection.empty();i.css({filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=image, src="+t+")"});a(function(){$("#ferret").css({filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale, src="+t+")"}).attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==");$(".upload-img").css({width:"100%",height:"100%",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale, src="+t+")"}).attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==")})}}else{t=getFileUrl(e.files[0]);i.attr("src",t)}$(".upload-btn").html("重传图片");$(".pop-cut-img").show();$(".upload-img-box").insertAfter($(".upload-preview-text"));initImgAreaSelect()});initImgAreaSelect=function(){$(".upload-btn").html("选择图片").removeClass("upload-btn-gray");$("#ferret").imgAreaSelect({aspectRatio:"1:1",handles:true,onSelectChange:preview,onSelectEnd:function(e,t){mixControl=Math.abs(t.x1-t.x2)*(cut.uploadImg.width/cut.uploadImg._width);if(mixControl<cut.mix){$cutControlTip.addClass("cut-control-tip-err")}else{$cutControlTip.removeClass("cut-control-tip-err")}var i={x1:cut.uploadImg.width*t.x1/cut.uploadImg._width,y1:cut.uploadImg.height*t.y1/cut.uploadImg._height,x2:cut.uploadImg.width*t.x2/cut.uploadImg._width,y2:cut.uploadImg.height*t.y2/cut.uploadImg._height};$('input[name="x1"]').val(i.x1);$('input[name="y1"]').val(i.y1);$('input[name="x2"]').val(i.x2);$('input[name="y2"]').val(i.y2)}})};$("#upload").submit(function(e){var self=$(this);if($('input[name="x1"]').val()===""){loadToastTmpl("fail","请选择图片剪裁区域！");return false}if(mixControl<cut.mix){loadToastTmpl("fail","裁剪图片不能小于"+cut.mix+"*"+cut.mix);return false}$(".upload-btn").html("正在上传...").addClass("upload-btn-gray");$("#ferret").imgAreaSelect({remove:true});self.ajaxSubmit(function(res){var result=eval("("+res+")");var opt;if(result.error_no===22e3){$(".imgareaselect-outer").hide();$editCover.attr("src",result.url);$(".upload-btn").html("选择图片").removeClass("upload-btn-gray");$(".select-pic").removeClass("select-pic-gray")}else{loadToastTmpl("fail","选择图片失败，请重试！")}initImgAreaSelect();popWindow.hide(editCoverPop)});e.preventDefault();return false});$("#city_4").citySelect({prov:$prov.data("address"),city:$city.data("address"),nodata:"none"});$.ms_DatePicker({YearSelector:".sel_year",MonthSelector:".sel_month",DaySelector:".sel_day"});$.ms_DatePicker();var sexType=$(".radio-boxed").data("sex");$(".radio-box").click(function(){var e=$(this);sexType=e.data("sex");$(".radio-box .check-icon").removeClass("checked-icon");$(".radio-box .check-icon"+sexType).addClass("checked-icon")});$submitBtn.click(function(){var e=$editName.val();if(!e||$.trim(e)==""){$editName.attr("nick",false).addClass("red-border");$nickErrorText.html("昵称不能为空").addClass("red");loadToastTmpl("fail","昵称不能为空");return false}if(e.length<editNameMin||e.length>editNameMax||!nickRe.test(e)){$editName.attr("nick",false).addClass("red-border");$nickErrorText.html("昵称需在2-24个字之间, 可以包含英文字母、中文、-、_、数字").addClass("red");loadToastTmpl("fail","昵称需在2-24个字之间, 可以包含英文字母、中文、-、_、数字");return false}if($editDesc.val().length>editDescMax){$editDesc.addClass("red-border");$descText.html(editDescMax-$editDesc.val().length).addClass("red");loadToastTmpl("fail","介绍信息不能超过140字");return false}var t=$(this);var i=[];$editSelectTagTips.find("a").each(function(e){i.push($(this).text())});var a="";if($editCover.attr("src")!==$editCover.attr("data-initpic")){a=$editCover.attr("src")}var o=$(".sel_year").val()+"/"+$(".sel_month").val()+"/"+$(".sel_day").val()+" 00:00:00";o=parseInt(new Date(o).getTime()/1e3);var r={bth_info:o||"",sex:sexType,nickname:$editName.val(),detail:$editDesc.val(),tag:i.toString(),userpic:a,province:$prov.val()||"",city:$city.val()||""};utils.tingApi("baidu.ting.ugccenter.userInfoUpdate",r).done(function(e){loadToastTmpl("succ","保存成功!");window.location.href="http://static3.qianqian.com/user"}).fail(function(e){var t="";switch(Number(e.error_code)){case 22001:case 22005:t="操作失败！";break;case 22452:t="还没有登录哦！";break;case 22708:t="昵称已被占用了，换一个试试！";break;case 22231:var i="";if(e.error_msg=="nickname"){i="昵称"};if(e.error_msg=="detail"){i="个人介绍"};t=i+"含有敏感内容，换一个吧";break}loadToastTmpl("fail",t)})});init()},init_secret=function(){if(opt.hasGetSecret){return}utils.tingApi("baidu.ting.ugccenter.getSetting","").done(function(e){if(e.error_code){$(".radio-box-set .check-icon").removeClass("checked-icon");$(".radio-box-set .check-icon"+e.status).addClass("checked-icon")}}).fail(function(e){});secret_event();opt.hasGetSecret=true},secret_event=function(){$(".radio-box-set").click(function(){var e=$(this);var t={status:e.data("settype")};utils.tingApi("baidu.ting.ugccenter.updateSetting",t).done(function(e){$(".radio-box-set .check-icon").removeClass("checked-icon");$(".radio-box-set .check-icon"+t.status).addClass("checked-icon");loadToastTmpl("succ","设置成功！")}).fail(function(e){loadToastTmpl("fail","设置失败，请重试！")})});$(".radio-box-set-log").click(function(){if(ting&&ting.logger){ting.logger.log("click",{page:"ugc_geRenSet",pos:"privacy"})}})},init_bind=function(){if(opt.hasGetBind){return}$(".bind-item").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});bind_event();opt.hasGetBind=true},bind_event=function(){$(".bind-set-box").on("click",".sina-bind-hook",function(){BSina.setAuth().done(function(){loadToastTmpl("succ","绑定成功");window.location.href="http://static3.qianqian.com/user/bind"});ting.logger.log("click",{page:"usercenter",pos:"weiboicon"})}).on("click",".sina-cancel-hook",function(){var e=$(this).data("sat");var t=popWindow.create({spPop:true,title:"确定要解绑微博账号吗？",text:{btnText:"确定"},callback:function(){BSina.revokeAuth(e).done(function(){loadToastTmpl("succ","解除绑定成功");window.location.href="http://static3.qianqian.com/user/bind"});popWindow.hide(t)}})})};return{init:function(type){common_event();switch(type){case"edit":opt.$tab=$(".user-set-tab .user-set");break;case"privacy":opt.$tab=$(".user-set-tab .secret-set");break;case"bind":opt.$tab=$(".user-set-tab .bind-set");break}var set=opt.$tab.data("set"),action=opt.$tab.data("action");opt.$set=$("."+set).eq(0);eval("init_"+action+"()")}}});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/