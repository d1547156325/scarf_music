define(["core/config","core/utils","widget/toast/toast","http://static0.qianqian.com/web/static/j/plugin/jquery.form","http://static0.qianqian.com/web/static/j/plugin/jquery.md5"],function(e,t,a){var n=function(e,t){var a=e.hookEl,n=a.attr("name")||"filePath";if(t){a.attr("multiple","multiple").prop("multiple",true);a.attr("name",n+"[]")}a.wrap('<form method="POST" enctype="multipart/form-data"></form>')},r=function(e,t){var n=t.length;if(e.KEY==="multiImg"){n+=e.baseEl.find("ul li img").length}if(n>e.MAX){a.show({data:{cls:"fail",text:"最多添加"+e.MAX+"个文件"}});return false}return true},i=function(e,t){var n=true,r=e.ACCEPT.replace(/\W+/g,"|").replace(/^\W|\W$/g,""),i=new RegExp("\\.("+(r?r:"")+")$","gi");$.each(t,function(e,t){var r=t.name||t;if(!r.match(i)){n=false;a.show({data:{cls:"fail",text:"文件格式错误"}});return}});return n},l=function(e,t){var n=true;$.each(t,function(t,r){var i=r.size;if(i>e.FILESIZE){n=false;a.show({data:{cls:"fail",text:"文件大小超过限制"}});return}});return n},o=function(e,t){var a=e.hookEl;a.change(function(a){var n=this,o=n.files||new Array(n.value);if(r(e,o)&&i(e,o)&&l(e,o)){$(n).parent("form").ajaxSubmit({url:e.CONF.url,type:"POST",dataType:"json",success:function(e){t.call(this,e)},error:function(e,t,a){console.log(e.responseText)}})}})};var u={KEY:"multiImg",MAX:3,ACCEPT:"jpg|jpeg|png|gif",FILESIZE:10*1048576,CONF:e.cfg.multiApi};var f=function(e){u=$.extend(u,e);n(u,true);c(u);o(u,function(e){for(var t=0;t<e.result.length;t++){var a=e.result[t];if(a.error_no==u.CONF.code.SUCCESS){u.baseEl.trigger("img:show",a)}}})},c=function(e){var t=e.baseEl.find("ul li");t.on("click",".remove",function(e){$(this).parent("li").data("file",null).empty()});e.baseEl.on("img:show",function(e,a){t.each(function(e,t){if(!$(t).data("file")){$(t).prepend('<img src="'+a.url+'" /><a href="javascript:;" class="remove"></a>').data("file",a.url);return false}return true})})};var s={KEY:"onlyMp3",MAX:1,ACCEPT:"mp3|aac|amr|wma|m4a|caf",FILESIZE:10*1048576,CONF:e.cfg.upImgApi};var m=function(e){s.CONF.url+="?restype=mp3&appid=cloudupload";s=$.extend(s,e);n(s);o(s,function(e){s.baseEl.val(e.file_name);$(".play-btn").remove();$(".play-hidden").show();$("#songId").val("");try{window.player.stop()}catch(t){}$("#songLink").val(e.url);$("#songMD5").val($.md5(e.file_name));$("#fileSize").val(e.file_size)})};return{multiImg:function(e){f(e)},onlyMp3:function(e){m(e)}}});

/** If u are interested in our code and would like to make it robust, just contact us^^ <@音乐前端> **/
/** Generated by M3D. **/